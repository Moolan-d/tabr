# 更新日志

## [1.1.0] - 2024-12-03

### 🆕 新增功能
- **Pixabay API 集成**: 替换原有的 500px 模拟方案，使用真实的 Pixabay API
- **智能搜索**: Pixabay API 支持多种搜索关键词，自动获取不同类型的风景照片
- **备用图片**: 当 API 不可用时，提供高质量的备用图片

### 🔄 变更
- **图片来源**: 从 "500px" 改为 "Pixabay"
- **API 接口**: `fetch500pxPhoto.ts` → `fetchPixabayPhoto.ts`
- **设置菜单**: 更新选项名称和描述
- **权限配置**: 添加 Pixabay API 访问权限

### 📋 技术细节

#### API 参数优化
- 图片类型: 仅照片 (photo)
- 方向: 横向 (horizontal) 
- 分类: 自然、地点、背景 (nature, places, backgrounds)
- 最小尺寸: 1920x1080 (适合新标签页)
- 安全搜索: 开启 (safesearch: true)

#### 搜索关键词
- nature landscape
- mountain sunset  
- ocean beach
- forest trees
- sky clouds
- flowers garden
- city skyline
- winter snow
- autumn colors
- spring blossom

### 🔧 配置说明

#### Pixabay API Key 获取
1. 访问 [pixabay.com/api/docs/](https://pixabay.com/api/docs/)
2. 注册账户
3. 获取免费 API Key
4. 在 `src/api/fetchPixabayPhoto.ts` 中替换 `YOUR_PIXABAY_API_KEY`

#### API 限制
- 免费用户: 100 请求/小时
- 图片缓存: 建议 24 小时 (符合 Pixabay 要求)
- 请求频率: 适中，避免过于频繁

### 🆙 升级指南

如果您之前使用了 500px 设置，需要：

1. **重新构建项目**:
   ```bash
   npm run build
   ```

2. **重新加载扩展**: 在 Chrome 扩展页面点击"重新加载"

3. **配置 API Key** (可选): 在新的 Pixabay API 文件中添加您的 API Key

4. **测试功能**: 打开新标签页，在设置中切换到 Pixabay 查看效果

### 📊 性能改进
- 更高质量的图片源
- 更稳定的 API 服务
- 更丰富的图片内容
- 更好的错误处理

### 🐛 修复
- 修复了模拟数据的局限性
- 改善了图片多样性
- 优化了加载失败时的用户体验

---

## [1.0.0] - 2024-12-03

### 🎉 初始版本
- Chrome 扩展新标签页替换
- Unsplash API 集成
- 500px 模拟数据
- React + TypeScript + Tailwind CSS
- 智能时钟和问候语
- 设置菜单和用户偏好存储 

# 🔄 Changelog - 预加载与缓存系统优化

## 📋 系统架构概述

本次更新完全重构了图片预加载与缓存系统，实现了智能的多层缓存策略，确保用户体验的流畅性和数据使用的高效性。

## 🎯 核心设计理念

- **预加载缓存**：永久有效，确保用户总能快速看到下一张图片
- **API缓存**：2分钟有效期，实现"2分钟内显示相同图片"的需求
- **智能预加载**：后台预加载新图片，避免重复当前图片

## 🔧 详细功能说明

### 1. 📚 缓存层级系统

#### API缓存层 (2分钟有效期)
- **作用**：确保2分钟内刷新页面显示相同图片
- **存储位置**：`chrome.storage.local`
- **缓存键**：`tabr_cache_unsplash` / `tabr_cache_pixabay`
- **更新策略**：无论图片来源（预加载缓存或API调用），都会设置新的API缓存

#### 预加载缓存层 (永久有效)
- **作用**：后台预加载图片，提升用户体验
- **存储位置**：`chrome.storage.local`
- **缓存键**：`tabr_preload_cache`
- **容量限制**：最多2张图片
- **有效期**：永久有效，只有被使用或主动清除才消失

### 2. 🔄 图片获取优先级策略

#### 正常加载流程：
```
1. API缓存(2分钟) → 有效则使用 ✅
    ↓ 失效
2. 预加载缓存 → 有则使用 → 设置新的API缓存 ✅
    ↓ 无
3. 直接API调用 → 设置新的API缓存 ✅
```

#### 强制刷新流程：
```
清除所有缓存 → 直接API调用 → 重新开始预加载
```

### 3. 🚀 智能预加载机制

#### 预加载触发时机：
- **使用预加载图片后**：立即补充1张新图片（100ms延迟）
- **首次加载后**：预加载2张图片（500ms延迟）
- **强制刷新后**：重新预加载2张图片（500ms延迟）
- **API缓存命中时**：确保预加载池充足（100ms延迟）

#### 预加载智能策略：
- **避免重复**：不会预加载当前显示的图片
- **去重检查**：不会预加载已有的图片
- **重试机制**：最多尝试5次获取不同图片
- **强制新图**：预加载时调用`skipCache=true`确保获取新图片

#### 预加载数量逻辑：
```typescript
if (forceMultiple) {
  // 强制预加载：补充到最大数量(2张)
  needCount = maxCacheSize - preloadCache.length;
} else {
  // 正常预加载：
  // - 缓存为空时预加载2张
  // - 缓存不足时补充1张
  // - 缓存充足时不预加载
  needCount = preloadCache.length === 0 ? 2 : 
             (preloadCache.length < maxCacheSize ? 1 : 0);
}
```

### 4. 🔄 轮播模式集成

#### 轮播模式优化：
- **2分钟定时器**：到时后优先使用预加载缓存
- **预加载整合**：使用预加载图片后立即补充缓存
- **回退机制**：无预加载数据时回退到收藏图片

### 5. 📊 存储结构

#### API缓存结构：
```typescript
interface CachedPhoto {
  data: PhotoData;
  timestamp: number;
  source: 'unsplash' | 'pixabay';
}
```

#### 预加载缓存结构：
```typescript
interface PreloadCache {
  photos: PhotoData[];      // 最多2张图片
  timestamp: number;        // 仅用于记录，不影响有效性
}
```

## ✅ 修复的问题

### 🐛 缓存更新问题
- **问题**：API缓存只在首次加载时设置，后续不更新
- **修复**：无论图片来源，都会设置新的API缓存
- **影响**：确保缓存能正常更新和失效

### 🐛 预加载循环引用问题
- **问题**：预加载时获取的是预加载缓存中的图片
- **修复**：预加载时强制跳过所有缓存(`skipCache=true`)
- **影响**：确保预加载获取真正的新图片

### 🐛 重复缓存检查问题
- **问题**：在`fetchPhoto`和API函数中重复检查缓存
- **修复**：统一在`fetchPhoto`中管理缓存策略
- **影响**：避免逻辑冲突，提高可维护性

## 🎯 用户体验改进

1. **即时显示**：页面加载时优先使用预加载图片，无需等待
2. **2分钟缓存**：短时间内刷新显示相同图片，符合用户预期
3. **流畅切换**：后台预加载确保下次切换瞬间完成
4. **智能节约**：避免重复下载相同图片，节省带宽

## 🔍 调试和监控

添加了详细的控制台日志，方便调试：
- `✅ 使用API缓存（2分钟内）`
- `✅ API缓存失效，使用预加载图片`
- `🔄 设置新的API缓存（来自预加载）`
- `🔄 无任何缓存，调用API获取新图片`
- `预加载完成：X张图片，缓存总数：Y`

## 📈 性能优化

1. **减少API调用**：多层缓存策略减少不必要的网络请求
2. **提前加载**：预加载机制消除用户等待时间
3. **智能管理**：自动维护预加载池，无需用户干预
4. **内存控制**：限制预加载数量，避免内存浪费

---

**总结**：本次更新建立了一个完整、高效、智能的图片缓存与预加载系统，在保证用户体验的同时优化了性能和资源使用。